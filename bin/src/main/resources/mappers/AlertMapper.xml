<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.repository.AlertDAO">

    <insert id="insertAlert" parameterType="AlertVO">
	    <selectKey keyProperty="alertId" resultType="int" order="BEFORE">
	        SELECT ALERT_SEQ.NEXTVAL FROM DUAL
	    </selectKey>
	    INSERT INTO ALERT (
	        ALERT_ID,
	        EMP_NO,
	        LINK_TYPE,
	        LINK_ID, 
	        CONTENT, 
	        ALERT_STATUS
	    ) VALUES (
	        #{alertId}, 
	        #{empNo},
	        #{linkType},
	        #{linkId}, 
	        #{content},
	        #{alertStatus}
	    )
	</insert>
	
	<select id="selectLatestAlerts" parameterType="String" resultType="AlertVO">
	    SELECT 
	        A.ALERT_ID,
	        A.EMP_NO,
	        A.LINK_TYPE,
	        A.LINK_ID,
	        A.CREATED_DATE,
	        A.IS_READ,
	        A.CONTENT AS content, -- [추가] 로그에서 확인한 알림 상세 내용
	        A.ALERT_STATUS,
	
	        -- ⭐ [제목 결정] 결재면 문서제목, 게시판이면 공지제목
	        CASE 
	            WHEN A.LINK_TYPE = 'APPROVAL' THEN D.DOC_TITLE
	            WHEN A.LINK_TYPE = 'BOARD' THEN N.NOTICE_TITLE
	            ELSE '알림'
	        END AS title,
	
	        -- ⭐ [작성자 이름 결정] 결재면 문서기안자, 게시판이면 공지작성자
	        CASE 
	            WHEN A.LINK_TYPE = 'APPROVAL' THEN E_APP.EMP_NAME
	            WHEN A.LINK_TYPE = 'BOARD' THEN E_BRD.EMP_NAME
	            ELSE '시스템'
	        END AS senderName,
	
	        -- ⭐ [시간 오류 해결] 알림 테이블의 생성 시간을 사용
	        A.CREATED_DATE AS sentTime
	
	    FROM ALERT A
	    -- 1) 결재 관련 조인
	    LEFT JOIN DOC D ON A.LINK_ID = D.DOC_NO AND A.LINK_TYPE = 'APPROVAL'
	    LEFT JOIN EMP E_APP ON D.DOC_WRITER = E_APP.EMP_NO
	    
	    -- 2) 게시판 관련 조인 (이게 추가되어야 null이 안 떠요!)
	    LEFT JOIN NOTICE_BOARD N ON A.LINK_ID = N.NOTICE_NO AND A.LINK_TYPE = 'BOARD'
	    LEFT JOIN EMP E_BRD ON N.EMP_NO = E_BRD.EMP_NO
	    
	    WHERE A.EMP_NO = #{empNo}
	      AND A.IS_READ = 'N' 
	    ORDER BY A.CREATED_DATE DESC
	</select>
    
    <update id="markAllAsRead" parameterType="String">
	    UPDATE 
	        ALERT
	    SET 
	        IS_READ = 'Y'
	    WHERE 
	        EMP_NO = #{empNo}
	        AND IS_READ = 'N'
	</update>

	<select id="selectUnreadCount" parameterType="String" resultType="int">
	    SELECT 
	        COUNT(ALERT_ID)
	    FROM 
	        ALERT
	    WHERE 
	        EMP_NO = #{empNo}
	        AND IS_READ = 'N'
	</select>
	
	<select id="selectAllLatestAlerts" parameterType="String" resultType="AlertVO">
	    SELECT 
	        A.ALERT_ID,
	        A.EMP_NO,
	        A.LINK_TYPE,
	        A.LINK_ID,
	        A.CREATED_DATE, -- 알림 자체가 생성된 시간을 기본으로 사용
	        A.IS_READ,
	        A.CONTENT AS content,  
	        A.ALERT_STATUS,
	        
	        -- ⭐ 1. 작성자 이름 결정 (결재면 문서 작성자, 공지면 공지 작성자)
	        CASE 
	            WHEN A.LINK_TYPE = 'APPROVAL' THEN E_APP.EMP_NAME
	            WHEN A.LINK_TYPE = 'BOARD' THEN E_BRD.EMP_NAME
	            ELSE '알림'
	        END AS senderName,
	
	        -- ⭐ 2. 시간 결정 (알림 테이블의 생성 시간을 최우선으로 사용)
	        A.CREATED_DATE AS sentTime
	
	    FROM ALERT A
	    -- 결재 관련 조인
	    LEFT JOIN DOC D ON A.LINK_ID = D.DOC_NO AND A.LINK_TYPE = 'APPROVAL'
	    LEFT JOIN EMP E_APP ON D.DOC_WRITER = E_APP.EMP_NO
	    
	    -- 게시판 관련 조인 (추가)
	    LEFT JOIN NOTICE_BOARD N ON A.LINK_ID = N.NOTICE_NO AND A.LINK_TYPE = 'BOARD'
	    LEFT JOIN EMP E_BRD ON N.EMP_NO = E_BRD.EMP_NO
	    
	    WHERE A.EMP_NO = #{empNo} 
	    ORDER BY A.CREATED_DATE DESC 
	    FETCH FIRST 50 ROWS ONLY
    </select>
    
    <delete id="deleteAlert" parameterType="map">
        DELETE FROM ALERT WHERE ALERT_ID = #{alertId} AND EMP_NO = #{empNo}
    </delete>

</mapper>