<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.repository.MessageDAO">

	<select id="selectMessageList" parameterType="string"
		resultType="MessageVO">
		WITH LAST_MESSAGE AS (
		-- 1. κ° λ€ν™”λ°©μ λ©”μ‹μ§€μ— μλ²μ„ λ¶€μ—¬
		SELECT
		T.*,
		ROW_NUMBER() OVER (
		PARTITION BY
		CASE
		-- μƒλ€λ°© μ‚¬λ²μ„ κΈ°μ¤€μΌλ΅ νν‹°μ…
		WHEN SENDER_EMP_NO = #{empNo} THEN RECEIVER_EMP_NO
		ELSE SENDER_EMP_NO
		END
		ORDER BY SEND_DATE DESC, MSG_NO DESC
		) AS RN
		FROM MESSAGE T
		WHERE (SENDER_EMP_NO = #{empNo} AND SENDER_DEL_YN = 'N')
		OR (RECEIVER_EMP_NO = #{empNo} AND RECEIVER_DEL_YN = 'N')
		),
		LATEST_MSG_NO AS (
		-- 2. RN=1 (κ°€μ¥ μµκ·Ό λ©”μ‹μ§€)μΈ ν–‰λ§ μ¶”μ¶ν•κ³ , OTHER_USER_IDλ¥Ό λ―Έλ¦¬ μ •μ
		SELECT
		LAST_MESSAGE.*,
		CASE
		WHEN SENDER_EMP_NO = #{empNo} THEN RECEIVER_EMP_NO
		ELSE SENDER_EMP_NO
		END AS OTHER_USER_ID -- π’΅ OTHER_USER_ID ν•„λ“λ¥Ό μ—¬κΈ°μ„ ν™•μ •
		FROM LAST_MESSAGE WHERE RN = 1
		),
		UNREAD_COUNT AS (
		-- 3. λ―Έν™•μΈ λ©”μ‹μ§€ κ°μ μΉ΄μ΄νΈ
		SELECT SENDER_EMP_NO AS OTHER_USER_ID, COUNT(MSG_NO) AS UNREAD_COUNT
		FROM MESSAGE
		WHERE RECEIVER_EMP_NO = #{empNo} AND IS_READ = 'N' AND RECEIVER_DEL_YN = 'N'
		GROUP BY SENDER_EMP_NO
		)
	
		-- 4. μµμΆ… λ©λ΅ μ΅°ν•© λ° μ‚¬μ©μ μ •λ³΄ μ΅°μΈ
		SELECT
		T1.OTHER_USER_ID,
		E.EMP_NAME AS otherUserName,
		D.DEPT_NO AS otherUserPosition,
		T1.MSG_CONTENT AS latestMessageContent,
		T1.SEND_DATE AS latestMessageTime,
		NVL(U.UNREAD_COUNT, 0) AS unreadCount
		FROM LATEST_MSG_NO T1
		-- λ€ν™” μƒλ€λ°© μ •λ³΄ μ΅°μΈ (T1.OTHER_USER_ID μ‚¬μ©)
		JOIN EMP E ON T1.OTHER_USER_ID = E.EMP_NO
		-- λ€ν™” μƒλ€λ°©μ λ¶€μ„ μ •λ³΄ μ΅°μΈ
		JOIN DEPT D ON E.DEPT_NO = D.DEPT_NO
		-- λ―Έν™•μΈ κ°μ μ΅°μΈ
		LEFT JOIN UNREAD_COUNT U ON T1.OTHER_USER_ID = U.OTHER_USER_ID
	
		ORDER BY T1.SEND_DATE DESC
	</select>
	
	<insert id="insertMessage" parameterType="MessageVO">
	    <selectKey keyProperty="msgNo" resultType="int" order="BEFORE">
	        SELECT SEQ_MSG_NO.NEXTVAL FROM DUAL
	    </selectKey>
	    INSERT INTO MESSAGE (
	        MSG_NO, SENDER_EMP_NO, RECEIVER_EMP_NO, MSG_CONTENT, SEND_DATE
	        ) VALUES (
	        #{msgNo},
	        #{senderEmpNo},
	        #{receiverEmpNo},
	        #{msgContent},
	        SYSDATE
	    )
	</insert>

</mapper>