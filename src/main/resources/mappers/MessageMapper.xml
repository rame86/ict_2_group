<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.repository.MessageDAO">

	<select id="selectMessageList" parameterType="string" resultType="MessageVO">
		WITH LAST_MESSAGE AS (
		-- 1. Í∞Å ÎåÄÌôîÎ∞©Ïùò Î©îÏãúÏßÄÏóê ÏàúÎ≤àÏùÑ Î∂ÄÏó¨
		SELECT
		T.*,
		ROW_NUMBER() OVER (
		PARTITION BY
		CASE
		WHEN SENDER_EMP_NO = #{empNo} THEN RECEIVER_EMP_NO
		ELSE SENDER_EMP_NO
		END
		ORDER BY SEND_DATE DESC, MSG_NO DESC
		) AS RN
		FROM MESSAGE T
		WHERE (SENDER_EMP_NO = #{empNo} AND SENDER_DEL_YN = 'N')
		OR (RECEIVER_EMP_NO = #{empNo} AND RECEIVER_DEL_YN = 'N')
		),
		LATEST_MSG_NO AS (
		-- 2. RN=1 (Í∞ÄÏû• ÏµúÍ∑º Î©îÏãúÏßÄ)Ïù∏ ÌñâÎßå Ï∂îÏ∂úÌïòÍ≥†, OTHER_USER_IDÎ•º ÎØ∏Î¶¨ Ï†ïÏùò
		SELECT
		LAST_MESSAGE.*,
		CASE
		WHEN SENDER_EMP_NO = #{empNo} THEN RECEIVER_EMP_NO
		ELSE SENDER_EMP_NO
		END AS OTHER_USER_ID -- VARCHAR2
		FROM LAST_MESSAGE WHERE RN = 1
		),
		UNREAD_COUNT AS (
		-- 3. ÎØ∏ÌôïÏù∏ Î©îÏãúÏßÄ Í∞úÏàò Ïπ¥Ïö¥Ìä∏
		SELECT SENDER_EMP_NO AS OTHER_USER_ID, COUNT(MSG_NO) AS UNREAD_COUNT
		FROM MESSAGE
		WHERE RECEIVER_EMP_NO = #{empNo} AND IS_READ = 'N' AND RECEIVER_DEL_YN = 'N'
		GROUP BY SENDER_EMP_NO
		)
	
		-- 4. ÏµúÏ¢Ö Î™©Î°ù Ï°∞Ìï© Î∞è ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï°∞Ïù∏
		SELECT
		T1.OTHER_USER_ID,
		NVL(E.EMP_NAME, 'Ïïå Ïàò ÏóÜÏùå') AS otherUserName,
		-- üí° NUMBERÏù∏ DEPT_NOÎ•º VARCHAR2Î°ú Î≥ÄÌôò ÌõÑ Ï∂úÎ†•
		NVL(TO_CHAR(D.DEPT_NAME), 'ÎØ∏Ï†ï') AS otherUserPosition,
		E.EMP_IMAGE AS otherUserImage,
		T1.MSG_CONTENT AS latestMessageContent,
		T1.SEND_DATE AS latestMessageTime,
		NVL(U.UNREAD_COUNT, 0) AS unreadCount
		FROM LATEST_MSG_NO T1
		-- üí° JOIN: VARCHAR2Ïù∏ OTHER_USER_IDÎ•º NUMBERÎ°ú Î≥ÄÌôòÌïòÏó¨ EMP_NO(NUMBER)ÏôÄ Ï°∞Ïù∏
		LEFT JOIN EMP E ON TO_NUMBER(T1.OTHER_USER_ID) = E.EMP_NO
		-- DEPT_NO (NUMBER)ÏôÄ DEPT_NO (NUMBER) Ï°∞Ïù∏
		LEFT JOIN DEPT D ON E.DEPT_NO = D.DEPT_NO
		LEFT JOIN UNREAD_COUNT U ON T1.OTHER_USER_ID = U.OTHER_USER_ID
	
		ORDER BY T1.SEND_DATE DESC
	</select>
	
	<insert id="insertMessage" parameterType="MessageVO">
	    <selectKey keyProperty="msgNo" resultType="int" order="BEFORE">
	        SELECT SEQ_MSG_NO.NEXTVAL FROM DUAL
	    </selectKey>
	    INSERT INTO MESSAGE (
	        MSG_NO, SENDER_EMP_NO, RECEIVER_EMP_NO, MSG_CONTENT, SEND_DATE
	        ) VALUES (
	        #{msgNo},
	        #{senderEmpNo},
	        #{receiverEmpNo},
	        #{msgContent},
	        SYSDATE
	    )
	</insert>
	
	<select id="selectChatMessages" resultType="MessageVO" parameterType="Map">
	    SELECT
	        MSG_NO,
	        SENDER_EMP_NO AS senderEmpNo,       
	        RECEIVER_EMP_NO AS receiverEmpNo,   
	        MSG_CONTENT AS msgContent,         
	        SEND_DATE AS sendDate,             
	        IS_READ
	    FROM MESSAGE
	    WHERE 
	        (SENDER_EMP_NO = #{myUserId} AND RECEIVER_EMP_NO = #{otherUserId}) 
	        OR 
	        (SENDER_EMP_NO = #{otherUserId} AND RECEIVER_EMP_NO = #{myUserId})
	    ORDER BY SEND_DATE ASC, MSG_NO ASC
	</select>
	
	<update id="updateIsRead" parameterType="Map">
	    UPDATE MESSAGE
	    SET IS_READ = 'Y'
	    WHERE 
	        RECEIVER_EMP_NO = #{myEmpNo}
	        AND SENDER_EMP_NO = #{otherUserId}
	        AND IS_READ = 'N'
	</update>
	
	<select id="selectUnreadMessages" resultType="MessageVO" parameterType="String">
	    SELECT *
	    FROM (
	        SELECT
	            T1.MSG_CONTENT AS msgContent,
	            T1.SENDER_EMP_NO AS senderEmpNo,
	            T1.SEND_DATE AS sendDate,
	            T2.EMP_NAME AS senderName, 
	            T2.EMP_IMAGE AS senderImage
	        FROM
	            MESSAGE T1  JOIN
	            EMP T2 ON T1.SENDER_EMP_NO = T2.EMP_NO
	        WHERE
	            T1.RECEIVER_EMP_NO = #{empNo}
	            AND T1.IS_READ = 'N'
	            AND T1.RECEIVER_DEL_YN = 'N' ORDER BY
	            T1.SEND_DATE DESC
	    )
	    WHERE ROWNUM &lt;= 5
    </select>
    
    <select id="selectEmpDept" resultType="EmpVO" parameterType="map">
    	SELECT
		    E.EMP_NO,
		    E.EMP_NAME, 
		    E.GRADE_NO,
		    E.EMP_EMAIL, 
		    E.EMP_IMAGE, 
		    D.DEPT_NAME AS deptName
		FROM
		    EMP E
		JOIN
		    DEPT D ON E.DEPT_NO = D.DEPT_NO
		WHERE
		    (#{keyword} IS NULL OR #{keyword} = '') OR 
		    (
		        E.EMP_NAME LIKE '%' || #{keyword} || '%'
		        OR E.EMP_NO LIKE '%' || #{keyword} || '%'
		    )
		AND E.EMP_NO != #{empNo}
    </select>

</mapper>