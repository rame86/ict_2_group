<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.repository.SalMapper">

    <!-- 1. 급여 대장: 사원 한 명의 월별 목록 -->
    <select id="selectSalList"
        parameterType="int"
        resultType="com.example.domain.SalVO">

    SELECT
        s.SAL_NUM      AS salNum,
        s.EMP_NO       AS empNo,
        s.MONTH_ATTNO  AS monthAttno,
        TO_CHAR(s.SAL_DATE,'YYYY-MM-DD') AS salDate,
        s.SAL_BASE     AS salBase,
        NVL(s.SAL_BONUS,0) AS salBonus,
        NVL(s.SAL_PLUS,0)  AS salPlus,
        s.INSURANCE    AS insurance,
        s.TAX          AS tax,
        s.REALPAY      AS realPay
    FROM SAL s
    WHERE s.EMP_NO = #{empNo}
    ORDER BY s.SAL_DATE DESC
</select>

    <!-- 2. 급여 명세서: 사원 + 월별 상세 -->
    <select id="selectSalDetail"
        parameterType="map"
        resultType="com.example.domain.SalVO">
    SELECT
        s.SAL_NUM      AS salNum,
        s.EMP_NO       AS empNo,
        s.MONTH_ATTNO  AS monthAttno,
        TO_CHAR(s.SAL_DATE,'YYYY-MM-DD') AS salDate,
        s.SAL_BASE     AS salBase,
        NVL(s.SAL_BONUS,0) AS salBonus,
        NVL(s.SAL_PLUS,0)  AS salPlus,
        s.INSURANCE    AS insurance,
        s.TAX          AS tax,
        s.REALPAY      AS realPay
    FROM SAL s
    WHERE s.EMP_NO      = #{empNo}
      AND s.MONTH_ATTNO = #{monthAttno}
</select>

    <!-- 3. 해당 월에 급여가 있는지 (옵션) -->
    <select id="existsSal" resultType="int">
        SELECT COUNT(*)
        FROM SAL
        WHERE MONTH_ATTNO = #{monthAttno}
    </select>

    <!-- 4. 사원 + 월 기준 존재 여부 (옵션) -->
    <select id="existsMonthlySalary"
        resultType="int">
    SELECT COUNT(*)
    FROM SAL
    WHERE EMP_NO      = #{empNo}
      AND MONTH_ATTNO = #{monthAttno}
</select>

    <!-- 5. 급여 INSERT (REALPAY까지 같이) -->
    <insert id="insertSal" parameterType="com.example.domain.SalVO">
        INSERT INTO SAL (
            SAL_NUM,
            MONTH_ATTNO,
            EMP_NO,
            SAL_DATE,
            SAL_BASE,
            SAL_BONUS,
            SAL_PLUS,
            INSURANCE,
            TAX,
            REALPAY
        ) VALUES (
            SAL_SEQ.NEXTVAL,
            #{monthAttno},
            #{empNo},
            SYSDATE,
            #{salBase},
            #{salBonus},
            #{salPlus},
            #{insurance},
            #{tax},
            (#{salBase}
             + NVL(#{salBonus},0)
             + NVL(#{salPlus},0)
             - #{insurance}
             - #{tax})
        )
    </insert>

</mapper>