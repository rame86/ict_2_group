<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.repository.SalMapper">

    <!-- 1. ì‚¬ì› ê°œì¸ ê¸‰ì—¬ ëª©ë¡ -->
    <select id="selectSalList" parameterType="string"
        resultType="com.example.domain.SalVO">
    SELECT
        s.SAL_NUM      AS salNum,
        s.MONTH_ATTNO  AS monthAttno,
        s.EMP_NO       AS empNo,

       <!-- ðŸ”¹ ì§€ê¸‰ì›” ë¼ë²¨: 2025ë…„ 11ì›” ì´ëŸ° í˜•íƒœ -->
        TO_CHAR(s.SAL_DATE, 'YYYY"ë…„ "MM"ì›”"') AS yearMonthLabel,


        s.SAL_BASE     AS salBase,
        NVL(s.SAL_BONUS, 0) AS salBonus,
        NVL(s.SAL_PLUS,  0) AS salPlus,
        s.INSURANCE    AS insurance,
        s.TAX          AS tax
    FROM SAL s
    WHERE s.EMP_NO = #{empNo}
    ORDER BY s.MONTH_ATTNO ASC
</select>

    <!-- 2. ê¸‰ì—¬ ìƒì„¸ -->
    <select id="selectSalDetail" parameterType="map"
            resultType="com.example.domain.SalVO">
        SELECT
            s.SAL_NUM      AS salNum,
            s.EMP_NO       AS empNo,
            s.MONTH_ATTNO  AS monthAttno,
            TO_CHAR(s.SAL_DATE, 'YYYY-MM-DD') AS salDate,
            s.SAL_BASE     AS salBase,
            NVL(s.SAL_BONUS, 0) AS salBonus,
            NVL(s.SAL_PLUS, 0)  AS salPlus,
            s.INSURANCE    AS insurance,
            s.TAX          AS tax,
            (s.SAL_BASE + NVL(s.SAL_BONUS,0) + NVL(s.SAL_PLUS,0)) AS payTotal,
            (s.INSURANCE + s.TAX) AS deductTotal,
            s.REALPAY      AS realPay
        FROM SAL s
        WHERE s.EMP_NO      = #{empNo}
          AND s.MONTH_ATTNO = #{monthAttno}
    </select>

    <!-- 3. í•´ë‹¹ ì›” ê¸‰ì—¬ ì¡´ìž¬ ì—¬ë¶€ -->
    <select id="existsSal" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM SAL
        WHERE MONTH_ATTNO = #{monthAttno}
    </select>

    <!-- 4. ì‚¬ë²ˆ+ì›” ê¸‰ì—¬ ì¡´ìž¬ ì—¬ë¶€ -->
    <select id="existsMonthlySalary" parameterType="map"
            resultType="int">
        SELECT COUNT(*)
        FROM SAL
        WHERE EMP_NO      = #{empNo}
          AND MONTH_ATTNO = #{monthAttno}
    </select>

    <!-- 5. ê¸‰ì—¬ 1ê±´ ì‚½ìž… (ìˆ˜ë™ ìž…ë ¥ìš©) -->
    <insert id="insertSal" parameterType="com.example.domain.SalVO">
        INSERT INTO SAL (
            SAL_NUM,
            MONTH_ATTNO,
            EMP_NO,
            SAL_DATE,
            SAL_BASE,
            SAL_BONUS,
            SAL_PLUS,
            INSURANCE,
            TAX
        ) VALUES (
            SEQ_SAL.NEXTVAL,
            #{monthAttno},
            #{empNo},
            TO_DATE(#{salDate}, 'YYYY-MM-DD'),
            #{salBase},
            #{salBonus},
            #{salPlus},
            #{insurance},
            #{tax}
        )
    </insert>

    <!-- 6. (êµ¬ë²„ì „) ê´€ë¦¬ìž ì „ì²´ ê¸‰ì—¬ ëª©ë¡ ì •ë ¬ìš© -->
    <select id="selectAdminSalList" parameterType="map"
            resultType="com.example.domain.SalVO">
        SELECT
            S.SAL_NUM     AS salNum,
            S.MONTH_ATTNO AS monthAttno,
            E.EMP_NO      AS empNo,
            E.EMP_NAME    AS empName,
            D.DEPT_NAME   AS deptName,
            S.SAL_BASE    AS salBase,
            S.SAL_BONUS   AS salBonus,
            S.SAL_PLUS    AS salPlus,
            S.INSURANCE   AS insurance,
            S.TAX         AS tax
        FROM SAL S
        JOIN EMP E ON S.EMP_NO = E.EMP_NO
        JOIN DEPT D ON E.DEPT_NO = D.DEPT_NO
        <!-- ì •ë ¬ choose ... (ìƒëžµ ê°€ëŠ¥. ëŒ€ì‹  ì•„ëž˜ getAdminSalList ì‚¬ìš©) -->
    </select>

    <!-- 7. ðŸ”¹ MONTH_ATTEND ê¸°ì¤€ ê¸‰ì—¬ ì¼ê´„ ìƒì„± -->
    <insert id="insertSalaryByMonth" parameterType="string">
        INSERT INTO SAL (
            SAL_NUM,
            MONTH_ATTNO,
            EMP_NO,
            SAL_DATE,
            SAL_BASE,
            SAL_BONUS,
            SAL_PLUS,
            INSURANCE,
            TAX,
            REALPAY
        )
        SELECT
            SAL_SEQ.NEXTVAL,
            T.MONTH_ATTNO,
            T.EMP_NO,
            TRUNC(T.MONTH_DATE_ATTEND, 'MM') + 14,
            T.BASE_SAL,
            0,
            T.OVERTIME_PAY,
            T.INSURANCE,
            T.TAX,
            T.REALPAY
        FROM (
            SELECT
                M.MONTH_ATTNO,
                M.EMP_NO,
                M.MONTH_DATE_ATTEND,
                E.BASE_SAL,
                ROUND((E.BASE_SAL / 160) * M.OVERTIME * 1.5) AS OVERTIME_PAY,
                ROUND((E.BASE_SAL + ROUND((E.BASE_SAL / 160) * M.OVERTIME * 1.5)) * 0.045) AS INSURANCE,
                ROUND((E.BASE_SAL + ROUND((E.BASE_SAL / 160) * M.OVERTIME * 1.5)) * 0.03)  AS TAX,
                (
                    E.BASE_SAL
                  + ROUND((E.BASE_SAL / 160) * M.OVERTIME * 1.5)
                  - ROUND((E.BASE_SAL + ROUND((E.BASE_SAL / 160) * M.OVERTIME * 1.5)) * 0.045)
                  - ROUND((E.BASE_SAL + ROUND((E.BASE_SAL / 160) * M.OVERTIME * 1.5)) * 0.03)
                ) AS REALPAY
            FROM MONTH_ATTEND M
            JOIN EMP E ON M.EMP_NO = E.EMP_NO
            WHERE TO_CHAR(M.MONTH_DATE_ATTEND, 'YYYY-MM') = #{targetMonth}
        ) T
        WHERE NOT EXISTS (
            SELECT 1
            FROM SAL S
            WHERE S.MONTH_ATTNO = T.MONTH_ATTNO
              AND S.EMP_NO     = T.EMP_NO
        )
    </insert>

    <!-- 8. ðŸ”¹ ê´€ë¦¬ìž í™”ë©´ìš© (ì›” í•„í„° + ì •ë ¬) -->
   <select id="getAdminSalList" parameterType="map"
        resultType="com.example.domain.SalVO">

    SELECT
        S.SAL_NUM      AS salNum,
        S.MONTH_ATTNO  AS monthAttno,
        S.EMP_NO       AS empNo,
        E.EMP_NAME     AS empName,
        D.DEPT_NAME    AS deptName,
       <!-- ðŸ”¹ salDateëŠ” ë¬¸ìžì—´ë¡œ ('YYYY-MM-DD') -->
        TO_CHAR(S.SAL_DATE, 'YYYY-MM-DD') AS salDate,
       <!-- ðŸ”¹ yearMonthLabel: "2025ë…„ 10ì›”" ê°™ì€ í‘œì‹œìš© ë¼ë²¨ -->
        TO_CHAR(S.SAL_DATE, 'YYYY"ë…„ "MM"ì›”"') AS yearMonthLabel,
        S.SAL_BASE     AS salBase,
        S.SAL_BONUS    AS salBonus,
        S.SAL_PLUS     AS salPlus,
        (S.INSURANCE + S.TAX) AS deductTotal,
        S.REALPAY      AS realPay
    FROM SAL S
    JOIN EMP  E ON S.EMP_NO = E.EMP_NO
    LEFT JOIN DEPT D ON E.DEPT_NO = D.DEPT_NO

    <where>
        <if test="month != null and month != ''">
            AND TO_CHAR(S.SAL_DATE, 'YYYY-MM') = #{month}
        </if>
    </where>

    <choose>
        <when test="sort == 'empNo'">
            ORDER BY S.EMP_NO ${dir}
        </when>
        <when test="sort == 'name'">
            ORDER BY E.EMP_NAME ${dir}
        </when>
        <when test="sort == 'dept'">
            ORDER BY D.DEPT_NAME ${dir}
        </when>
        <otherwise>
            ORDER BY S.SAL_DATE ${dir}, S.EMP_NO ASC
        </otherwise>
    </choose>

</select>

</mapper>
