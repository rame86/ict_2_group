<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.repository.SalMapper">

     <!-- 사번(empNo)으로 급여 내역 리스트 조회 -->
    <select id="selectSalList" parameterType="string"
            resultType="com.example.domain.SalVO">
        SELECT
            s.SAL_NUM      AS salNum,
            s.MONTH_ATTNO  AS monthAttno,
            s.EMP_NO       AS empNo,
            TO_CHAR(s.SAL_DATE, 'YYYY-MM-DD') AS salDate,
            s.SAL_BASE     AS salBase,
            NVL(s.SAL_BONUS, 0) AS salBonus,
            NVL(s.SAL_PLUS, 0)  AS salPlus,
            s.INSURANCE    AS insurance,
            s.TAX          AS tax,
            s.REALPAY      AS realPay
        FROM SAL s
        WHERE s.EMP_NO = #{empNo}
        ORDER BY s.SAL_DATE DESC
    </select>

    <!-- 2. 급여 명세서: 사원 + 월별 상세 -->
    <select id="selectSalDetail"
        parameterType="map"
        resultType="com.example.domain.SalVO">
    SELECT
        s.SAL_NUM      AS salNum,
        s.EMP_NO       AS empNo,
        s.MONTH_ATTNO  AS monthAttno,
        TO_CHAR(s.SAL_DATE,'YYYY-MM-DD') AS salDate,
        s.SAL_BASE     AS salBase,
        NVL(s.SAL_BONUS,0) AS salBonus,
        NVL(s.SAL_PLUS,0)  AS salPlus,
        s.INSURANCE    AS insurance,
        s.TAX          AS tax,
        s.REALPAY      AS realPay
    FROM SAL s
    WHERE s.EMP_NO      = #{empNo}
      AND s.MONTH_ATTNO = #{monthAttno}
</select>

    <!-- 3. 해당 월에 급여가 있는지 (옵션) -->
    <select id="existsSal" resultType="int">
        SELECT COUNT(*)
        FROM SAL
        WHERE MONTH_ATTNO = #{monthAttno}
    </select>

    <!-- 4. 사원 + 월 기준 존재 여부 (옵션) -->
    <select id="existsMonthlySalary"
        resultType="int">
    SELECT COUNT(*)
    FROM SAL
    WHERE EMP_NO      = #{empNo}
      AND MONTH_ATTNO = #{monthAttno}
</select>

   <!-- 급여 명세서 등록 -->
    <insert id="insertSal" parameterType="com.example.domain.SalVO">
        INSERT INTO SAL (
            SAL_NUM,
            MONTH_ATTNO,
            EMP_NO,
            SAL_DATE,
            SAL_BASE,
            SAL_BONUS,
            SAL_PLUS,
            INSURANCE,
            TAX,
            REALPAY
        ) VALUES (
            SEQ_SAL.NEXTVAL,
            #{monthAttno},
            #{empNo},
            TO_DATE(#{salDate}, 'YYYY-MM-DD'),
            #{salBase},
            #{salBonus},
            #{salPlus},
            #{insurance},
            #{tax},
            #{realPay}
        )
    </insert>

<!-- 관리자용 급여 대장: 모든 급여 + 사원명 + 부서명 -->
<select id="selectAdminSalList"
        resultType="com.example.domain.SalVO">

    SELECT
        s.SAL_NUM      AS salNum,
        s.MONTH_ATTNO  AS monthAttno,
        s.EMP_NO       AS empNo,
        TO_CHAR(s.SAL_DATE, 'YYYY-MM-DD') AS salDate,
        s.SAL_BASE     AS salBase,
        NVL(s.SAL_BONUS, 0) AS salBonus,
        NVL(s.SAL_PLUS, 0)  AS salPlus,
        s.INSURANCE    AS insurance,
        NVL(s.TAX, 0)  AS tax,
        s.REALPAY      AS realPay,
        e.EMP_NAME     AS empName,
        d.DEPT_NAME    AS deptName
    FROM SAL s
        JOIN EMP e  ON s.EMP_NO = e.EMP_NO
        LEFT JOIN DEPT d ON e.DEPT_NO = d.DEPT_NO
    ORDER BY
        s.MONTH_ATTNO DESC,
        s.EMP_NO ASC
</select>


</mapper>